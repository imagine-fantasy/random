-- Create the schema
CREATE SCHEMA IF NOT EXISTS cc_cards;

-- Set the search path
SET search_path TO cc_cards, public;

-- Create the cardholders table
CREATE TABLE IF NOT EXISTS cardholders (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    first_name VARCHAR(50) NOT NULL,
    last_name VARCHAR(50) NOT NULL,
    email VARCHAR(100) NOT NULL UNIQUE,
    company VARCHAR(100) NOT NULL,
    credit_limit DECIMAL(12, 2) NOT NULL,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

-- Create the form_factors table
CREATE TABLE IF NOT EXISTS form_factors (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(20) NOT NULL UNIQUE
);

-- Insert default form factors
INSERT INTO form_factors (name) VALUES ('DIGITAL'), ('EMBOSSED');

-- Create the card_creations table
CREATE TABLE IF NOT EXISTS card_creations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    cardholder_id UUID NOT NULL,
    form_factor_id UUID NOT NULL,
    request_date TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    processor_response JSONB NOT NULL,
    status VARCHAR(20) NOT NULL,
    card_number VARCHAR(16) NOT NULL,
    FOREIGN KEY (cardholder_id) REFERENCES cardholders(id),
    FOREIGN KEY (form_factor_id) REFERENCES form_factors(id)
);

-- Create indexes
CREATE INDEX IF NOT EXISTS idx_cardholders_email ON cardholders(email);
CREATE INDEX IF NOT EXISTS idx_card_creations_cardholder_id ON card_creations(cardholder_id);
CREATE INDEX IF NOT EXISTS idx_card_creations_form_factor_id ON card_creations(form_factor_id);
CREATE INDEX IF NOT EXISTS idx_card_creations_status ON card_creations(status);
CREATE INDEX IF NOT EXISTS idx_card_creations_card_number ON card_creations(card_number);